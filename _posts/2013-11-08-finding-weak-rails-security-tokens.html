---
layout: post
title: Finding Weak Rails Security Tokens
date: 2013-11-08 11:30:26.000000000 -05:00
type: post
published: true
status: publish
categories: []
tags: []
meta:
  _edit_last: '20119316'
  _publicize_pending: '1'
  publicize_twitter_user: averagesecguy
  publicize_twitter_url: http://t.co/JL54thAyuv
  _wpas_done_648456: '1'
  _publicize_done_external: a:1:{s:7:"twitter";a:1:{i:244128388;b:1;}}
  publicize_linkedin_url: http://www.linkedin.com/updates?discuss=&scope=45960739&stype=M&topic=5804615822450102272&type=U&a=yBqV
  _wpas_done_648455: '1'
  _oembed_b100dbc53bec9f9b4854cd080cf12587: '{{unknown}}'
  _oembed_ea47ccefdec98e0a9b6ef125085a2d63: '{{unknown}}'
  _oembed_d6967f97b665a6a67514727fbf265397: '{{unknown}}'
  _oembed_a730871207a6b32624798c58113ca138: '{{unknown}}'
  _oembed_1517ed287a48fa4684f575a4066c0731: '{{unknown}}'
  _oembed_a3621c2e49e985254c2702ce44cb6e9f: '{{unknown}}'
  _oembed_9a32fa41a067d8e629b3c5ca002cfe08: '{{unknown}}'
  _oembed_669e53d65a4cdcea53c95d0efbfdca64: '{{unknown}}'
  _oembed_5ef3776cf9ba1c941da28dd291647610: '{{unknown}}'
  _oembed_66c48cba9e0444a611873340031adf4c: '{{unknown}}'
  _oembed_3b2c48a2aa5bcb27d029c4721d8e73f0: '{{unknown}}'
  _oembed_450f402e016585b7a6e3486f5812a8e6: '{{unknown}}'
  _oembed_f6687e204ec76c61ded1352943126b01: '{{unknown}}'
  _oembed_632d23015255c1c397087e6861c8f8f9: '{{unknown}}'
  _oembed_4ed05dd7bec28cc20e3ad153e0163af3: '{{unknown}}'
  _oembed_302ac9644baa8020a816f0f5dbe57320: '{{unknown}}'
  _oembed_e45e6851a2272e804809a640e30e614c: '{{unknown}}'
  _oembed_f3fe3a08cf4d6c3d6b7b83abd51a19ac: '{{unknown}}'
  _oembed_ca8d6cdedb614133927f381b767c0628: '{{unknown}}'
  _oembed_ec03c1634239235e0a4446ec66a953af: '{{unknown}}'
author:
  login: averagesecurityguy
  email: stephen@averagesecurityguy.info
  display_name: averagesecurityguy
  first_name: ''
  last_name: ''
---
<p>The other day I was <a href="http://robertheaton.com/2013/07/22/how-to-hack-a-rails-app-using-its-secret-token/" title="Hacking Rails using secret_token">reading about the dangers</a> of having your Rails secret token in your version control system. The TL;DR version is secret tokens are used to calculate the <a href="http://en.wikipedia.org/wiki/Hash-based_message_authentication_code" title="Wikipedia HMAC Definition">HMAC</a> of the session data in the cookie. If you know the secret token you can send arbitrary session data and execute arbitrary code.</p>
<p>So I decided I'd go digging through Github to see if anyone had uploaded secret tokens to the site. Sure enough, there were more than a few secret tokens. This isn't all bad because Rails allows different configuration settings in the same application depending on whether the app is in production or development and most of the Rails apps used a strong secret_token read from an environment variable or generated by SecureRandom for the production site but a weak secret_token for development the site.</p>
<p>I took a few minutes to record the secret tokens I found and decided to see if I could find any of them in use on Internet facing sites. To test this I went to Shodan to find Rails servers and found approximately 70,000 servers. I downloaded the details for about 20,000 of those servers and looked at the cookies to identify the ones running Rails apps. Rails cookies are distinct because they consist of a base64 encoded string followed by a -- and then a HMAC of the base64 string. This gives a cookie, which looks like this.</p>
<pre>
_Lm2Web_session=BAh7BjoPc2Vzc2lvbl9pZCIlOGY0NTUyMWIyMDMw
NzVmNzI1NjY2ZWEyODg0MzY0ODA%3D--1cad1b4cd816f15162af4ab
97598032a994668be
</pre>
<p>Of the roughly 20,000 Rails servers, for which I had details, only about 10,000 had cookies that matched the pattern above.</p>
<p>The digest of the cookie is produced by calculating the HMAC of the base64 string using the SHA1 hashing algorithm and the secret token as the salt. To find the secret token we simply calculate the HMAC using each of the potential secret tokens as the salt and see if the calculated digest matches the digest in the cookie. Of the approximately 10,000 cookies, I was able to find 7 secret tokens. This is not very impressive at all but it gave me hope to try a larger test.</p>
<p>I decided to check the Alexa top 1 million web sites to see how many used a cookie with a digest, and for how many I could find the secret token. I've tested about 40,000 sites so far and have only found 303 sites that use a cookie that matches the pattern above. Of those 303 sites, I did not find any of the secret tokens. The results are not surprising and I realize this is a long shot that will probably come to nothing but sometimes you just have to test a theory. If I finish the testing I'll update the blog post with the final stats.</p>
<p>Although I haven't tried it yet, I believe that if you ran the same test on an internal network you would have more success because there is more likely to be development Rails servers on an internal network. If you'd like to try this on your network you can get the rails_find.py, rails_secret_token.py, and rails_secret_tokens.text files <a href="https://github.com/averagesecurityguy/scripts" title="AverageSecurityGuy scripts repository on Github.">here</a>. The rails_find.py script takes a list of host names or IP addresses and writes any matching cookies to a file. The rails_secret_token.py script takes a file of cookies and the rails_secret_tokens.txt file and tests each token against each cookie.</p>
<p>If you do find a secret token during your testing, Metasploit will get you <a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/http/rails_secret_deserialization.rb" title="Metasploit exploit for Rails secret token.">remote code execution</a>.</p>
<p>Enjoy.</p>
